package com.budgeting.backend.service;import com.budgeting.backend.dto.in.ActivatingCategoriesInHouseHold;import com.budgeting.backend.dto.out.CategoryWithSubResponse;import com.budgeting.backend.dto.out.SubCategoryResponse;import com.budgeting.backend.entity.*;import com.budgeting.backend.repository.CategoryTemplateRepository;import com.budgeting.backend.repository.Custom.HouseholdCategoryAggregationRepositoryImpl;import com.budgeting.backend.repository.HouseHoldCategoryRepository;import com.budgeting.backend.repository.HouseHoldSubCategoryRepository;import com.budgeting.backend.repository.SubCategoryTemplateRepository;import org.bson.types.ObjectId;import org.springframework.beans.factory.annotation.Autowired;import org.springframework.security.access.prepost.PreAuthorize;import org.springframework.stereotype.Service;import org.springframework.transaction.annotation.Transactional;import java.util.ArrayList;import java.util.Collections;import java.util.List;import java.util.Map;import java.util.stream.Collectors;@Servicepublic class CategoryService {    private final CategoryTemplateRepository categoryTemplateRepository;    private final SubCategoryTemplateRepository subCategoryTemplateRepository;    private final HouseHoldCategoryRepository houseHoldCategoryRepository;    private final HouseHoldSubCategoryRepository houseHoldSubCategoryRepository;    private final HouseholdCategoryAggregationRepositoryImpl householdCategoryAggregationRepository;    @Autowired    public CategoryService(CategoryTemplateRepository categoryTemplateRepository,                           SubCategoryTemplateRepository subCategoryTemplateRepository,                           HouseHoldSubCategoryRepository houseHoldSubCategoryRepository,                           HouseHoldCategoryRepository houseHoldCategoryRepository,                           HouseholdCategoryAggregationRepositoryImpl householdCategoryAggregationRepository){        this.categoryTemplateRepository = categoryTemplateRepository;        this.subCategoryTemplateRepository = subCategoryTemplateRepository;        this.houseHoldCategoryRepository = houseHoldCategoryRepository;        this.houseHoldSubCategoryRepository = houseHoldSubCategoryRepository;        this.householdCategoryAggregationRepository = householdCategoryAggregationRepository;    }    /**     * The user will use this when they are the very first time getting all the categories which they want to use     * @return list of all the Category     */    /**     * The user will use this when they are the very first time getting all the categories which they want to use     * @return list of CategoryWithSubResponse containing default templates     */    public List<CategoryWithSubResponse> getAllCategories() {        // 1️⃣ Fetch default categories (parents)        List<CategoryTemplate> categories =                categoryTemplateRepository.findByIsDefaultTrue();        // 2️⃣ Fetch default subcategories (children)        List<SubCategoryTemplate> subCategories =                subCategoryTemplateRepository.findByIsDefaultTrue();        // 3️⃣ Group subcategories by PARENT TEMPLATE ObjectId        Map<ObjectId, List<SubCategoryResponse>> subCategoryMap =                subCategories.stream()                        .collect(Collectors.groupingBy(                                SubCategoryTemplate::getParentCategoryTemplateId,                                Collectors.mapping(                                        sc -> new SubCategoryResponse(                                                sc.getId().toHexString(),   // DTO = String                                                sc.getName(),                                                sc.getIcon()                                        ),                                        Collectors.toList()                                )                        ));        // 4️⃣ Build final response        return categories.stream()                .map(category -> {                    CategoryWithSubResponse response = new CategoryWithSubResponse();                    response.setCategoryId(category.getId().toHexString()); // DTO = String                    response.setName(category.getName());                    response.setType(category.getType());                    response.setSubCategories(                            subCategoryMap.getOrDefault(                                    category.getId(),                    // ObjectId key                                    Collections.emptyList()                            )                    );                    return response;                })                .toList();    }    /**     * This is used to find all the categories and sub categories used by the user and return all of them     * @param houseHoldId household id of the group     * @param userId user id which we extract in the middleware     * @return return what every category user have decided to use     */    @PreAuthorize("@houseHoldSecurity.isUserPartOfHouseHold(#houseHoldId, #userId)")    public List<CategoryWithSubResponse> getAllCategories(String houseHoldId, User userId){       return householdCategoryAggregationRepository.fetchByHousehold(houseHoldId);    }    @Transactional    @PreAuthorize("@houseHoldSecurity.isUserPartOfHouseHold(#houseHoldId, #user.userId)")    public void activatingCategoriesInHouseHold(List<ActivatingCategoriesInHouseHold> categories, User user,                                                String houseHoldId) throws IllegalArgumentException {        List<HouseHoldSubCategory> subCategoryList = new ArrayList<>();        ObjectId parentCategoryId = null;        for(int i=0;i<categories.size();i++){            ActivatingCategoriesInHouseHold current = categories.get(i);            if (current.isParent()) {                parentCategoryId = houseHoldCategoryRepository.save(new HouseHoldCategory(current,                        new ObjectId(houseHoldId))).getId();            } else {                assert parentCategoryId != null;                current.setParentId(parentCategoryId.toString());                if (current.getParentId() != null)                    subCategoryList.add(new HouseHoldSubCategory(current,houseHoldId));                else                    throw new IllegalArgumentException("Subcategory must have parent category at all cost");            }        }        houseHoldSubCategoryRepository.saveAll(subCategoryList);    }}